# 20.要避免的最佳实践和陷阱

我们已经详细探讨了名为 Azure Functions 的服务的不同概念。您已经了解了使用 C#构建 Azure 函数并将其部署到 Azure 环境的可用机制。您还探索了如何为 Azure 函数创建 Azure DevOps 管道。您基于常用的触发器和绑定创建了几个 Azure 函数，并了解了许多重要方面，这些方面将有助于您使用函数构建企业级解决方案。到目前为止，您已经掌握了在生产场景中使用函数的所有必要知识。

在前一章中，你学习了如何将 Azure 功能与 Logic Apps 解决方案集成。在本章中，您将探索在设计和构建函数时应该遵循的最佳实践。

## 本章的结构

在本章中，您将探索 Azure Functions 服务的以下设计方面:

*   设计指南和最佳实践

*   要避免的陷阱

## 目标

学习完本章后，您将能够做到以下几点:

*   使用 Azure 函数设计高效的无服务器解决方案

*   了解使用 Azure 函数设计和构建功能的注意事项

## 设计指南和最佳实践

在为 Azure 功能构建解决方案时，您必须遵循设计指南并实现最佳实践。遵循最佳实践将确保您构建高效、健壮、容错、高可用性和高可伸缩性的解决方案。Azure Functions 是一个无服务器的服务，你对底层的托管基础设施和每个功能如何扩展没有任何控制权。因此，您必须设计基于 Azure 功能的解决方案，以优化的方式在底层基础设施上运行，并根据业务需求进行扩展。尽管您对底层代码没有任何控制权，但您可以高效地设计您的解决方案，并以最佳方式利用底层基础设施和托管环境。您只需选择最适合您业务需求的设计。例如，如果您需要构建一个将在 Azure 函数上运行的长时间运行的任务，将这个长时间运行的任务放在消费计划上可能不是一个好主意。消费计划可以运行您的任务 10 分钟，之后执行将超时。换句话说，你不能在消费计划上运行 Azure 函数中的任何代码超过 10 分钟。您还需要决定一种有效的方法来管理和监控执行应用程序代码的函数。

让我们探索一下这里列出的一些最佳实践和设计指南，您必须遵循它们来使用 Azure Functions 服务构建一个基于的解决方案:

*   决定是否在您的场景中使用函数

*   选择最佳的编程语言

*   选择最佳的托管计划

*   选择有状态或无状态的解决方案

*   减少延迟启动

*   获得适合你预算的账单

*   处理长时间运行的代码

*   促进其他 Azure 和外部服务之间的集成和通信

*   识别和管理瓶颈

*   让您的解决方案具有容错能力

*   保护使用 Azure 函数开发的 API

*   促进有效监控和调试故障

*   整合开发运维实践，引入基础设施即代码(IaC)方法

*   引入防御性编程方法

### 决定是否在您的场景中使用函数

在理想情况下，函数是无服务器的产品。您对底层基础设施或托管环境没有任何控制权。您甚至无法控制缩放方面；底层基础架构可根据应用需求进行扩展。因此，您必须验证您的代码是否可以在无服务器产品中运行。

您可能需要对宿主环境进行更好的控制，或者需要安装一些额外的软件来支持代码的执行。在这种情况下，你不能在 Azure 函数上执行你的代码。在 Azure Functions 的情况下，您没有操作底层托管环境或在底层基础设施上安装任何软件的选项。这里你可能有两个选择。您可以为您需要的额外软件寻找平台即服务(PaaS)产品，并从基于 PaaS 的软件中使用软件，或者选择在基础架构即服务(IaaS)虚拟机上托管您的应用程序。例如，假设您开发了一个使用 Apache Kafka 的. NET 核心 API。在本地服务器上，您可以安装 Apache Kafka 并托管。NET 核心 API 项目。如果您计划在 Azure 函数上托管 API，您应该使用 Azure Service Bus，这是 Azure 上 Apache Kafka 的替代 PaaS 服务，然后托管。Azure 函数上的. NET 核心 API。或者，您可以使用虚拟机并将这两个组件一起安装在虚拟机上。

同样的。NET 核心 API 和 Apache Kafka 示例，API 代码在。NET 核心 API 项目可能会运行更长时间。Azure 函数最适合短时间运行代码。在这种情况下，你应该考虑在 Azure WebApp 上托管你的代码，并使用 Azure 服务总线而不是 Apache Kafka。或者，你可以选择使用 Azure 虚拟机。在纯无服务器功能的情况下，使用消费计划。但是，您可以使用与 App 服务计划相同的专用计划，因为使用专用计划几乎与使用 Azure WebApp 相同。

使用 PaaS 解决方案可以让您更好地控制扩展方面。您可以定义自动缩放规则，甚至选择手动缩放。如果你需要对扩展方面有更好的控制，最好将你的代码托管在 Azure WebApp 上，而不是 Azure 函数上。

Note

综上所述，如果你需要对托管环境有更大的控制权，那么就在虚拟机上托管你的代码。如果你能为代码依赖找到一个替代的 PaaS 服务，那么就去找 Azure WebApp。在 Azure Web App 和虚拟机的情况下，您可以更好地控制扩展方面。

### 选择正确的编程语言

为您的应用程序选择编程语言非常重要。您可以使用各种编程语言(如 C#、Java、Python、TypeScript、PowerShell 等)来实现 Azure 功能。然而，在选择一种编程语言之前，要验证这种编程语言是否能够轻松处理该场景的所有需求。可能会有这样一种情况，一种受支持的编程语言覆盖了部分需求，而另一种编程语言支持其余的需求。例如，要托管在功能 app 上的应用程序需要与不公开 REST 端点的第三方应用程序进行交互。相反，第三方应用程序支持使用 Java 包来连接应用程序。在这种情况下，您需要识别与这个第三方应用程序交互的所有必要代码，然后将应用程序代码分成多个块。使用 Java 包进行交互的块将使用基于 Java 编程语言的函数，所有其他块都可以使用基于 C#的函数。在这种情况下，可以考虑基于不同的编程语言将需求拆分到多个 Azure 功能上。

我们在将工作负载迁移到云时面临的另一个挑战是开发人员的现有技能。你可能会发现一些开发人员没有合适的技能来使用你为 Azure 函数选择的编程语言来构建代码。在这种情况下，您可以选择用所选编程语言所需的必要技能来交叉培训您的开发人员，或者您可以使用开发人员现有的技能来检查您的功能是否可以通过变通方法来实现。

### 托管计划的选择

为 Azure 功能选择正确的托管计划是一个重要的设计方面。如果您计划构建一个纯粹的无服务器场景，您可以选择使用消费计划。以下是消耗计划的特征:

*   仅在 Azure 功能执行时支付

*   短时间间隔运行

*   无法控制底层基础架构或托管环境

*   无法控制 Azure 功能如何扩展

如果您有短时间间隔运行的代码，您可以选择使用消耗计划。底层基础设施将管理 Azure 功能的所有扩展方面。如果传入负载增加，底层基础设施会为 Azure 函数添加新的实例，并平衡负载。当负载减少时，额外的实例会自动停止使用。您无法控制函数如何缩放，也无法控制在缩放过程中删除和添加的实例数量。您为添加的所有功能实例付费。但是，您只需为代码运行的时间间隔付费。如果您有一个运行时间间隔很短的函数，并且您不需要控制 Azure 函数的缩放方面，那么您应该选择消费计划。

一旦执行完成，该函数就开始工作并进入睡眠状态。下一次需要执行函数时，不是瞬间的。一旦被触发，它就从睡眠状态中醒来并开始执行。因此，当函数从睡眠状态中醒来时，服务请求总会有延迟。这种服务请求的延迟被称为*冷启动*现象。但是，一旦该功能被激活，只要该功能不进入睡眠状态，您就不会面临冷启动现象。为了避免这种冷启动问题，您可以使用保费计划。高级计划保证至少有一个实例始终可用于服务您的传入请求。通过选择高级计划支持的一个级别，您还可以在一定程度上控制计算需求。

你可能需要 Azure 函数运行更长的时间。例如，如果你已经有一个应用服务计划，你可以将其与托管长期运行代码的 Azure 函数共享。在这种情况下，您可以使用专用计划或应用服务计划。然而，专用计划不是真正的无服务器功能，与应用服务计划相同。您可以定义自动缩放设置，并完全控制函数的缩放方式。

Note

综上所述，如果你有一个真正的无服务器场景，你的代码运行时间很短，那么选择消费计划。为避免冷启动问题，您可以使用高级计划或专用计划。如果您有长时间运行的代码，并且您需要更好地控制函数如何伸缩，您也可以使用专用计划。

### 选择有状态或无状态的解决方案

您需要评估客户场景，并决定是否需要将执行状态从一个函数传递到另一个函数。例如，假设您正在构建一个购物车应用程序。您有一个函数来验证客户订单，并在付款完成时将付款状态传递给下一个处理订单的函数。在这种情况下，您需要将数据从第一个函数传递到另一个函数。您可能有一个更复杂的场景，其中您需要构建多个函数，并且每个函数都像工作流一样执行。例如，您可能有两个处理数据的函数，这两个函数会将数据发送到第三个函数，第三个函数会聚合数据并对其进行进一步处理。您需要为所有这样的场景构建一个有状态的解决方案。您可以使用 Azure 持久功能编排有状态功能工作流。我们应该为所有这样的场景使用 Azure 持久功能服务，在这些场景中，您可以方便地在功能之间交换数据和状态。

您可能会有一些简单的场景，比如根据时间表执行代码，或者构建一个 Azure 函数集来执行 CRUD 操作，并在使用 HTTP 触发器调用时向您提供数据结果。在这种情况下，您可以使用 Azure 函数而不是 Azure 持久函数，因为您对维护和在函数之间交换数据不感兴趣。

Note

您也可以使用 Azure Logic 应用程序构建工作流。对于所讨论的有状态场景，您可以使用逻辑应用程序来代替持久函数。然而，持久函数最适合程序员。程序员可以使用持久函数在更大程度上定制实现。

### 减少延迟启动

Azure 函数在被触发时执行。一旦它们完成执行，它们就进入空闲状态，最后进入睡眠状态。Azure 函数只有在被触发时才会唤醒并开始执行。然而，这些功能在被触发时不会立即开始执行。它们需要一些时间从睡眠状态中醒来，并在开始处理请求之前预热。如上所述，这种现象被称为*冷启动*现象。如果您正在构建一个实时应用程序，那么该功能需要一直处于活动状态。它必须在被调用后立即执行。您必须至少有一个预热的实例，该实例可以在函数被触发时立即开始执行。对于所有这样的场景，您不能使用在消费计划上运行的 Azure 函数。您可以选择使用 Azure WebApp 或其他服务来设计替代解决方案，以满足应用程序的实时需求。或者，你可以选择在一个高级计划上运行你的 Azure 功能。高级计划确保至少有一个实例始终处于运行状态，并准备好为传入的请求提供服务。

例如，假设您正在构建一个监控房间温度的物联网(IoT)应用程序。如果温度超过特定限制，物联网应用程序需要调用 Azure 函数，该函数可以立即生成通知或警告。您不能在消费计划上运行此 Azure 函数，因为您可能会在触发时遇到启动 Azure 函数的延迟，这将延迟通知的生成。如果通知被延迟，那么对于被监控的房间中的设备和系统会有严重的后果。为了解决这种情况，您应该使用高级计划或寻找替代的 PaaS 服务来按需为系统生成通知。

### 获得符合您预算的正确账单

在为您的应用程序设计基于云的解决方案时，成本规划是一个重要方面。在 Azure Functions 中，你无法控制托管应用程序的伸缩性。当传入的负载增加时，会动态地添加新的实例，并且会为添加的所有实例向您收费。但是，您会收到该函数在该实例上执行期间的账单。您可能会遇到这样一种情况，您的应用程序需要在高峰时段进行指数级扩展。在这种情况下，会动态添加新的实例来处理传入的流量，您的成本会呈指数级增长。在设计 Azure 函数时，你可能没有考虑到指数级扩展。在这样的场景中，你必须考虑所有的扩展场景，并推导出 Azure 函数的实际成本。您还可以选择选项来控制缩放的程度，并计划 Azure 函数可以缩放的实例数量，以便 Azure 函数产生的成本在限制范围内。

### 处理长时间运行的代码

Azure 函数最适合托管执行时间较短的代码。但是，您可能会遇到需要长时间运行代码的情况。在这种情况下，您应该考虑将代码分成更小的块，并在 Azure 函数中运行这些函数。您可能需要运行一个长时间运行的应用程序。例如，您需要运行一个执行时间间隔更长的轮询应用程序。将此类应用程序分割成较小的块时，您可能会遇到困难。您可以选择在一个专门的计划上运行 Azure 函数，该计划允许代码运行更长的时间间隔来解决这种情况。或者，您可以选择在 web 作业上运行 Azure 函数作为后台进程或 WebApp。

Note

你可以将长时间运行的代码分成更小的块，并在 Azure 函数中运行这些更小的块。在一些无法将代码分解成更小单元的场景中，可以将代码托管在专用计划上运行的 Azure 函数上。

### 促进其他 Azure 和外部服务之间的集成和通信

您可能需要将 Azure 功能与其他 Azure 服务或外部服务集成在一起。例如，Azure 函数需要从 Apache Kafka 队列中挑选数据并对其进行处理。在所有这样的场景中，检查是否存在可用于与服务交互的现有绑定。如果没有可用的现有绑定，请尝试构建一个自定义绑定来帮助您与其他服务交互和交换数据。绑定帮助您以声明的方式与其他服务进行交互，并且您不需要编写太多的代码来完成这项工作。但是，假设您发现没有支持您的场景的现有绑定，并且为该场景实现自定义绑定并不容易。在这种情况下，您可以选择在 Azure 函数中实现自定义代码，或者构建一个能够促进与外部服务通信的外部组件。

你需要确保你可以安全地与其他 Azure 服务和外部组件通信。确保您引入了最佳安全实践，以确保您的实现尽可能地安全、可靠和容错。安全实践可以包括为您的函数访问配置跨源资源共享(CORS ),监控传入的请求头和主体参数，过滤掉不需要的或恶意的请求，验证函数应用的身份验证和授权，等等。

### 识别和管理瓶颈

Azure 函数是无服务器的组件，底层基础设施负责所有的扩展需求。这些功能可以自动扩展到相当大的规模，以管理传入的负载。然而，Azure 功能可以与其他基于 PaaS 或 IaaS 的服务接口，这些服务可以在特定限制内扩展。例如，您有一个在消费计划上运行的 Azure 函数。Azure 函数将数据插入到 Azure SQL 数据库实例中。在高峰时段，大量并发请求冲击 Azure 函数，该函数扩展到大量实例来处理传入流量。这些函数实例中的每一个都可能同时命中 Azure SQL 数据库实例。Azure SQL 数据库可能无法扩展到这种程度并处理传入流量。此操作将导致 Azure SQL 数据库实例的性能瓶颈。即使 Azure 函数可以扩展和处理传入的负载，SQL 数据库实例也无法扩展到那个程度。您的解决方案作为一个整体会导致性能瓶颈。您必须识别所有这样的场景，并实施策略来处理它们。您可能需要使用排队机制来控制 Azure 功能的并发程度。您可以在队列中添加要处理的项目，然后将有限数量的项目发送给 Azure 函数进行处理，以避免在向外扩展以管理传入负载时产生大量实例。

### 让您的解决方案具有容错能力

您必须使您的解决方案具有容错能力。如果 Azure 函数无法处理请求，您必须有机制再次处理请求。您应该有一个健壮的重试机制。重试次数应该是一个有限的数字，并且很容易针对解决方案进行配置。例如，如果函数未能处理一个请求，它应该将失败的请求发送到一个队列，并累积所有失败的请求。在特定的时间间隔之后，它应该为失败的队列逐个挑选项目并处理请求。

您可能有一个场景，其中 Azure 函数从队列中选取一个项目并处理该项目。Azure 函数可能会遇到这样的问题:由于另一个依赖服务不可用，该函数将选取项目，但无法处理它。此操作将导致该函数从队列中选取项目，而不处理它们。您最终会丢失队列中的所有项目，并且没有任何项目得到处理。在所有这些场景中，您必须实现断路器模式。如果该函数未能处理队列中的项目，它不应该选择队列中的下一个项目。它不应该挑选任何项目，直到依赖的服务启动，项目可以得到处理。此外，它应该将失败的项目添加到另一个队列中，以便稍后重试处理它。

Note

function app 可以调用运行在 Azure 环境中的其他服务，也可以调用运行在 Azure 外部的内部环境或其他云中的服务。这些服务可能无法处理请求，即使这些服务失败，功能 app 也会一次又一次地不断调用这些服务。断路器模式将有助于监控这些服务呼叫。在合理数量的连续失败后，它会指示功能 app 不要像你在断路一样调用这些服务。

在很多情况下，我们都需要有一个容错机制。引入容错机制是非常必要的，这样 Azure 函数才能高效地执行业务功能。

### 保护使用 Azure 函数开发的 API

使用 HTTP 触发的 Azure 函数构建 API。这些 API 可以执行各种各样的操作，既可以是简单的 CRUD 操作，也可以是复杂的业务逻辑处理。您必须保护这些 API 以防止未经授权的访问。保护它们的最佳方式是将 HTTP 触发的 Azure 功能与 Azure API 管理服务或类似的第三方服务集成在一起。您对这些功能的所有请求都将通过 API 管理服务进行路由。您可以配置和管理标题和正文中的请求和响应参数，配置 CORS 设置，决定允许和不允许谁，以及使用 API 管理服务执行许多此类活动。您甚至可以将 API 管理服务与 Azure Active Directory 集成，并执行基于 OAuth 的身份验证。

### 促进有效监控和调试故障

您必须确保将 Application Insights 或任何其他替代的监控和日志记录第三方解决方案与 Azure 功能相集成。日志和度量帮助您调试应用程序。对于 Azure 函数，您无法访问底层代码托管基础架构。因此，您必须记录所有信息和失败，以找出根本原因，并使用日志进行审计活动。

Application Insights 提供了一种高效的机制来捕获日志和指标。您可以获得丰富的指标和日志可视化，帮助您轻松分析您的应用程序、托管基础架构和托管环境。

### 整合 DevOps 实践并引入 IaC 方法

您应该避免在门户中使用 Azure 功能，并构建自动化来创建、部署和管理 Azure 功能。您可以创建自动化脚本来帮助您自动化与 Azure 函数的交互。自动化减少了手动错误，从长远来看，您将从中受益。例如，假设您需要在客户的生产环境中复制数百个 Azure 功能。如果使用门户创建这些 Azure 功能，将会花费大量时间。你可能容易犯错误，因为这个过程是重复的和手动的。为了有效地解决这种情况，你应该构建自动化来帮助你快速地、零错误地创建 Azure 函数。

您可以使用 Azure CLI、Azure PowerShell 和 IaC 产品(如 Terraform 或 Chef)来为您的 Azure 功能构建自动化。您还可以使用 ARM 模板来构建自动化解决方案。使用 Azure DevOps，您可以构建 IaC 管道来提升 Azure 功能，构建和打包功能代码的持续集成，以及将包部署到 Azure 功能的持续部署管道。

开发运维成熟的组织更喜欢使用自动化解决方案来创建和管理云资源和基础架构。您可以为 IaC 活动生成日志，以便将来进行分析和审计。

### 引入防御性编程方法

应用程序在运行时可能会遇到异常。在运行时异常和故障期间处理业务功能时，您应该遵循防御方法。例如，假设您的函数正在处理上传到 Blob 存储中的几幅图像。处理 30 幅图像后，出现异常，该函数试图从第一幅图像开始再次处理图像。作为一个好的实践，该函数不应该处理前 30 个图像，因为它们已经被处理过了，它应该尝试从第 31 个图像开始处理图像。在防御性编程方法中，函数应该准确地从异常发生时停止的地方恢复处理。或者，您可以在死信队列或病毒队列中插入失败的记录，并尝试处理病毒或死信队列中的记录，而不是处理所有记录。

## 要避免的陷阱

以下是使用 Azure Functions 服务设计应用程序时必须避免的一些陷阱:

*   在单一功能应用服务中共享功能

*   一次处理一个输入数据

*   在同一功能应用服务中托管生产和开发功能

*   跨功能应用服务共享存储帐户

### 在单一功能应用服务中共享功能

不要把你所有的功能都放在一个单一功能的 app 服务里。如果应用服务中有太多的功能，您的功能应用可能无法获得足够的计算资源来扩展和优化执行。仔细分析资源计算要求，然后规划您可以在函数应用程序服务中托管的函数数量。您可以根据 Azure 功能执行的业务功能的性能或可伸缩性对其进行逻辑分组。

### 一次处理一个输入数据

不要一个接一个地处理输入数据。您进行了一次往返，该函数在每次获取输入数据时都保持忙碌。最糟糕的是当您将输入数据作为触发器的一部分时。这些功能需要反复触发。尽量批量获取输入数据，批量处理数据。此操作将提高性能。

### 在同一功能应用服务中托管生产和开发功能

不使用相同功能的 app 服务托管生产和开发功能。针对不同的场景，将功能 app 服务分开。功能应用服务在托管计划上运行。托管计划定义了功能应用服务的底层基础设施和计算需求。如果您在多个功能应用程序之间使用相同的托管计划，底层基础架构将被共享，从而影响功能应用程序的性能。在开发环境中运行的功能应用可能比在实际生产环境中运行的功能应用需要更少的计算能力。因此，与生产环境相比，您在开发环境中需要一个较低的托管计划。因此，建议根据计算需求，在自己的托管计划上运行单独的功能应用服务。尽可能多地利用部署插槽。您可能计划为登台环境准备一个部署插槽，为生产环境准备一个插槽。您可以将新的代码更改升级到登台槽，测试登台槽中的代码，一旦所有测试通过，就将登台槽中的代码与生产槽中的代码进行交换。新的代码更改将进入生产插槽，而先前在生产插槽中运行的旧代码将在登台插槽中。这种交换机制将确保旧的生产代码在登台槽中完好无损，并且可以在需要时回滚到生产槽中。

### 跨功能应用服务共享存储帐户

创建存储帐户时，您必须将其与功能应用服务相关联。不要在托管功能的功能应用服务之间共享存储帐户。共享存储帐户会降低 Azure 功能的性能，在某些场景下，每个功能都可能产生大量的存储事务。

## 摘要

在这一章中，你学习了如何高效地使用 Azure 函数设计解决方案。您探索了使用 Azure 函数设计解决方案时要遵循的最佳实践。您还探索了在为 Azure 函数构建解决方案时必须避免的陷阱。你对 Azure 函数的规划越好，你就越有可能使用 Azure 函数构建一个高性能且健壮的解决方案。

以下是本章的要点:

*   您必须遵循最佳实践来构建高性能且健壮的 Azure 功能。

*   最佳实践包括选择正确的托管计划，使用正确的编程语言来适应您的场景，为您的 Azure function 解决方案规划成本，在失败的情况下整合重试机制，等等。

*   您必须避免诸如与大量功能共享一个功能 app 服务、共享存储帐户、不批量处理数据以及为生产和开发场景保留不同的功能 app 服务等陷阱。

我们已经到了这本书的结尾。在本书中，您学习了在为 Azure Functions 服务设计功能时，如何设计、构建、部署、管理和遵循最佳实践。您学习了一些高级概念，比如如何在 Azure Kubernetes 服务上详细使用持久函数和运行函数。到目前为止，您应该理解了构建生产级 Azure 函数所需的所有必要概念。