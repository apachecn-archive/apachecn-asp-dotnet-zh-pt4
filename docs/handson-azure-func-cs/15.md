# 15.使用 CI/CD 管道和 Azure DevOps 部署 Azure 功能

在开发和部署软件应用程序时，在最终应用程序完成和部署之前，您会使用多个过程。这通常包括需求收集、系统设计、开发、测试和部署等阶段，而与遵循的 SDLC 模型无关。这些流程过去非常耗时，开发和运营团队不同步。在当前要求苛刻的业务场景下，您需要更短的上市时间来发布产品的新功能，以服务于您的最终客户。

为了满足更快交付应用和功能的需求，组织已经采用了 DevOps 原则和实践，通过克服与遵循传统 SDLC 模型相关的障碍来提高团队的效率。在传统的设置中，开发和运营团队通常是相互隔离的，这使得很难将功能迁移或回滚到不同的环境。通过整合开发运维实践，如敏捷规划、持续集成(CI)、持续交付(CD)和监控，您可以确保开发人员、运营、QA 和安全团队之间的无缝协作和沟通，通过强大的回滚机制快速交付和交付产品，以满足客户需求并降低成本。

在前面的章节中，您探索了构建解决方案的方法以及用不同的 ide 将它们部署到 Azure 的方法。本章的重点将是探索使用 CI/CD 管道和 Azure DevOps 将你的功能项目部署到 Azure 的方法。这也可以使用 GitHub 动作来完成。

## 本章的结构

本章将探讨以下主题:

*   Azure DevOps 是什么

*   创建构建管道并使用 Azure 管道实现持续集成

*   创建发布管道并使用 Azure 管道实现持续部署

## 目标

学习完本章后，您将能够做到以下几点:

*   在 Azure DevOps 中使用 GitHub 存储库

*   使用 Azure 构建 CI/CD 管道来部署功能项目

## 什么是 Azure DevOps？

典型的应用程序生命周期包含多个阶段，如规划、开发、交付和运营。DevOps 团队使用各种工具来帮助他们完成每个阶段。例如，一些组织使用像 Atlassian 的吉拉这样的工具来协作和计划 sprints，执行问题跟踪，并添加功能请求，但他们使用不同的工具集，如 Jenkins 或 GitHub 来交付。通过 Azure DevOps，微软在统一的平台上提供了一套服务，在应用程序生命周期的所有阶段帮助您的 DevOps 团队。

Azure DevOps 提供以下服务来帮助团队在应用程序生命周期的所有阶段提高团队的效率:

*   Azure Repos :有了 Azure Repos，团队可以跟踪他们代码库的变化，并提供一种有效的方式来记录他们的开发历史。这是一个由 Azure DevOps 提供的版本控制系统，您可以在其中创建多个私有存储库，并协作添加功能或解决 bugs 问题。

*   Azure Boards :有了 Azure Boards，团队可以协作、计划、跟踪和监控任务、特性请求以及与项目相关的问题。它提供了对 Scrum 和看板的本地支持。您可以创建一个仪表板来直观地监控项目的进度。

*   *Azure Pipelines* :有了 Azure Pipelines，团队就可以实践持续集成和持续交付，来构建和运送各种语言开发的产品到不同的目标环境。它有助于创建构建包和执行单元测试以及其他任务，例如使用市场上第三方供应商的任务进行漏洞评估。

*   Azure 测试计划:有了 Azure 测试计划，团队可以在浏览器中执行各种测试，比如探索性测试、手动测试或用户验收测试。Azure 测试计划为 QA 团队提供了在浏览器中执行端到端跟踪测试所需的所有资源。

*   Azure 工件:有了 Azure 工件，团队可以创建 NPM、NuGet 或 Maven 软件包，并与团队的其他成员从公共和私有来源共享。它是 Azure DevOps 中作为服务提供的包管理解决方案。

Note

Maven 是一个 Java 项目管理软件，帮助您轻松构建、打包、版本化和运行 Java 应用程序。您可以使用 Maven 项目配置文件添加将在 Java 项目中引用的外部包，Maven 将在构建应用程序时包含这些包。

在深入本章之前，您需要在 Azure 中提供一个功能应用程序，您将在其中部署您的功能项目，然后将您的功能项目提交给一个存储库。我创建了一个名为 funcchapter15 的函数 app，暂时不包含任何函数。在本章的后面，我将展示如何使用 Azure Pipelines 将函数项目中的函数部署到这个函数应用程序中。见图 [15-1](#Fig1) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig1_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig1_HTML.jpg)

图 15-1

创建功能应用程序

虽然 Azure DevOps 为您提供了创建私有存储库的服务，但我们将在本章使用 GitHub。我在 GitHub 中创建了一个名为`Chapter15FunctionApp`的资源库。你可以在 [`https://github.com/AshirwadSatapathi/Chapter15FunctionApp`](https://github.com/AshirwadSatapathi/Chapter15FunctionApp) 找到源代码。

这个存储库包含一个带有 HTTP 触发的函数的函数项目，该函数返回一个个性化的消息以及为查询字符串传递的值`name`或在请求正文中发送的值`name`。您可以复制这个存储库或者使用您自己的存储库来学习本章内容。

现在您已经创建了一个功能应用程序和一个存储库，您已经准备好创建您的 CI/CD 管道了。

## 在 Azure DevOps 中创建项目

转到 [`https://dev.azure.com`](https://dev.azure.com) 并点击“登录”以登录您的 Azure DevOps 帐户。

Note

如果您是第一次注册，系统会提示您输入组织名称，并选择您希望其托管的地区。

要创建项目，请转到要创建项目的组织，然后单击“+新建项目”见图 [15-2](#Fig2) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig2_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig2_HTML.jpg)

图 15-2

单击“+新项目”

系统将提示您在新屏幕上输入项目详细信息。输入项目名称和描述，选择 Private 作为可见性，然后选择 Git 作为版本控制系统。然后将“工作项目流程”设置为您在组织中遵循的流程。例如，如果您的组织遵循 Scrum，那么在这里选择 Scrum。填写完所有必需的信息后，单击 Create 创建项目。见图 [15-3](#Fig3) 。这将创建项目并将您重定向到项目屏幕。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig3_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig3_HTML.jpg)

图 15-3

单击创建

## 在 Azure DevOps 中创建构建管道并实现持续集成

若要创建生成管道，请单击“管道”，然后单击“创建管道”。见图 [15-4](#Fig4) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig4_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig4_HTML.jpg)

图 15-4

单击创建管道

在 Azure DevOps 中创建管道的最简单方法是使用经典编辑器。您还可以使用 YAML 脚本来创建构建和部署管道。现在，点击“使用经典编辑器”，如图 [15-5](#Fig5) 所示。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig5_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig5_HTML.jpg)

图 15-5

点按“使用经典编辑器”

选择 GitHub 作为源。这将提示您创建一个连接，以允许访问 GitHub 存储库的管道。您可以通过使用 OAuth 授权或使用 GitHub 个人访问令牌来创建连接。您将通过单击“使用 OAuth 授权”来创建连接这将提示您使用 GitHub 凭证登录，并给予连接所需的权限。见图 [15-6](#Fig6) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig6_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig6_HTML.jpg)

图 15-6

单击“使用 OAuth 授权”

单击授权 AzurePipelines 以允许对管道的权限并创建连接。见图 [15-7](#Fig7) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig7_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig7_HTML.jpg)

图 15-7

单击授权 AzurePipelines

您必须选择包含您的项目文件的存储库和分支。选择后，单击继续。见图 [15-8](#Fig8) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig8_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig8_HTML.jpg)

图 15-8

单击继续

Azure DevOps 提供了基于应用的多个模板。因为您的应用程序是使用。NET，我们来搜索一下 *azure 函数。NET* 在搜索框中点击模板中的【应用】，如图 [15-9](#Fig9) 所示。或者，您也可以从空工单开始。见图 [15-9](#Fig9) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig9_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig9_HTML.jpg)

图 15-9

选择模板，然后单击应用

Azure DevOps 将生成一个构建管道，其中包含在代理作业中构建您的功能项目所需的预填充任务。这些是构建功能项目所需的最小任务集。

Note

您可以从第三方供应商(如 WhiteSource)提供的 Azure Marketplace 中添加更多任务，以在构建管道中执行漏洞评估，并在构建管道执行后查看漏洞报告。你可以在 [`www.whitesourcesoftware.com/resources/`](http://www.whitesourcesoftware.com/resources/) 找到更多信息。

您可以通过添加任务或将代理规范更改为 Mac 或 Ubuntu 而不是 vs2017-win2016 来配置代理作业。让我们单击 Save 来保存构建管道。如果您想要执行构建管道，您可以在进行必要的更改后通过单击 Save & Queue 来手动启动它，或者如果您没有进行任何更改，只需单击 Queue 来启动构建过程。参见图 [15-10](#Fig10) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig10_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig10_HTML.jpg)

图 15-10

单击保存

您可能已经注意到，您在管道中没有测试任务。理想情况下，应该添加它来运行项目解决方案中存在的所有单元和集成测试，但是因为您没有为该解决方案编写任何单元测试，所以您没有将它添加到管道中。这样，您就为 Azure Functions 项目创建了可以手动触发的构建管道。但是对于项目的大部分，手动启动构建过程是没有意义的。理想的情况是，有一种机制可以在每次代码提交到存储库时自动启动构建过程。您可以通过为您的构建管道启用持续集成来实现这一点。

要启用持续集成，请单击触发器选项卡，然后选中复选框“启用持续集成”此外，选择“包括”作为类型，并将分支规范定义为主规范。您在分支规范中选择 master，因为您希望每次在 Master 分支中进行更改时都启动构建过程。如果您想在某个其他分支发生变更时启动构建过程，那么您应该在这里定义它。要保存更改，您必须启用连续延续并启动构建过程。单击保存并排队。参见图 [15-11](#Fig11) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig11_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig11_HTML.jpg)

图 15-11

支持持续集成

在开始构建过程之前，您将看到一个对话框，用于输入一些信息并对现有配置进行任何更改。您可以在这里添加注释，但这完全是可选的。输入所需信息或根据需要更改任何配置详细信息后，单击“保存并运行”开始构建过程。参见图 [15-12](#Fig12) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig12_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig12_HTML.jpg)

图 15-12

点击“保存并运行”

构建管道将在队列中停留一段时间，并且应该在构建代理可用时立即启动。要查看构建的每个任务并查看与每个任务关联的日志，请单击“代理作业 1”参见图 [15-13](#Fig13) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig13_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig13_HTML.jpg)

图 15-13

单击“代理作业 1”

在此屏幕上，您可以查看每个任务的状态，也可以通过单击查看与每个任务相关联的日志。所有任务成功完成后，您会看到所有任务都有一个绿色复选标记。参见图 [15-14](#Fig14) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig14_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig14_HTML.jpg)

图 15-14

查看任务及其日志的状态

在本节中，您创建了一个构建管道，并启用了持续集成。现在，每当您的存储库中发生变化时，构建过程将在没有任何人工干预的情况下启动，从而使构建过程自动化。但是您只生成了构建包并发布了构建工件。您需要将构建包部署到您的函数应用程序中。

## 在 Azure DevOps 中创建发布管道，并实现持续交付

要使用构建管道生成的构建包来部署功能项目，您需要创建一个发布管道。

要创建发布管道，请转到“管道”，单击“发布”，然后单击“新建管道”参见图 [15-15](#Fig15) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig15_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig15_HTML.jpg)

图 15-15

创建新的发布管道

系统将提示您选择模板类型。既然要部署函数项目，搜索*函数*，选择“将函数 app 部署到 Azure functions”，点击应用。这将填充开箱即用部署所需的一组任务。见图 [15-16](#Fig16) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig16_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig16_HTML.jpg)

图 15-16

选择一个模板

你得给这个舞台起个名字。既然这种情况下你只有一个功能 app，那就命名为**制作**吧。根据解决方案的不同，发布管道中可能有多个阶段。见图 [15-17](#Fig17) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig17_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig17_HTML.jpg)

图 15-17

输入阶段的名称

因为您已经选择了模板类型并命名了阶段，所以让我们添加工件。单击+添加或“+添加工件”来执行此操作。在一个发布管道中可以有多个工件。参见图 [15-18](#Fig18) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig18_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig18_HTML.jpg)

图 15-18

向发布管道添加工件

你会在边上看到一个弹出窗口；它要求您选择源类型和源。源是您要在此发布管道中部署其构建包的构建管道。默认情况下，它将选择最新版本作为默认版本，并生成源别名。当您选择 Latest 作为默认版本时，发布管道将选择由构建管道为部署生成的最新构建包。输入必填字段后，单击添加。参见图 [15-19](#Fig19) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig19_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig19_HTML.jpg)

图 15-19

单击添加

您已经添加了工件，并配置了发布管道来获取最新的构建包进行部署，但是您没有配置它在每次生成新的构建包时启动。理想情况下，您希望发布管道在新构建一生成就开始部署过程。这个过程也被称为*持续部署*。要在您的发布管道中启用持续部署，请单击图 [15-20](#Fig20) 中突出显示的 thunderbolt 图标。现在你会在边上看到一个弹出窗口。您需要切换 Enabled 按钮，将连续部署触发器设置为 on。这将在您的发布管道中实现持续集成支持。见图 [15-20](#Fig20) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig20_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig20_HTML.jpg)

图 15-20

启用连续部署触发器

Note

除了提供添加连续部署的机制之外，Azure DevOps 还提供了一种拥有预部署条件的方式，例如为特定用户的每个阶段设置预部署批准。这是一个有用的特性。

您已经添加了工件，选择了阶段的模板，并为发布管道配置了连续部署，但是您还没有配置代理作业和任务。为此，点击图 [15-21](#Fig21) 中突出显示的“1 个工作，1 个任务”。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig21_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig21_HTML.jpg)

图 15-21

单击“一项工作，一项任务”

当您选择模板为“将功能应用部署到 Azure 功能”时，它会将部署 Azure 功能应用任务添加到您的代理，但您必须配置参数。您需要选择 Azure 订阅并授权发布管道访问订阅中的所有资源。现在，您需要在 Windows 上选择 func App 作为应用程序类型，并选择 funcchapter15 作为应用程序服务名称，这是您在本章开始时创建的功能应用程序。填写必填字段后，单击保存保存所做的更改。参见图 [15-22](#Fig22) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig22_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig22_HTML.jpg)

图 15-22

配置任务并保存更改

单击“创建发布”开始部署流程。参见图 [15-23](#Fig23) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig23_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig23_HTML.jpg)

图 15-23

点击“创建发布”

您将会看到一个新的屏幕，在这里您将会看到与您的发布相关的详细信息，比如工件的阶段名称以及源别名。您可以在此屏幕上添加版本描述，然后单击创建开始部署过程。参见图 [15-24](#Fig24) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig24_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig24_HTML.jpg)

图 15-24

单击创建开始部署过程

要查看部署状态，请单击 Release-1，如图 [15-25](#Fig25) 所示。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig25_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig25_HTML.jpg)

图 15-25

单击版本 1

在此屏幕上，您可以查看阶段的部署状态。要查看任务的状态及其日志，您需要点击日志，如图 [15-26](#Fig26) 所示。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig26_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig26_HTML.jpg)

图 15-26

单击日志

您可以在此屏幕上查看与发布管道相关的所有任务的状态。要查看特定任务的日志，您可以单击它。部署完成后，您将看到所有任务的绿色复选标记，以及阶段名称旁边的“成功”消息，如图 [15-27](#Fig27) 中突出显示的。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig27_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig27_HTML.jpg)

图 15-27

查看部署状态

现在，您的发布管道已经成功完成了部署，让我们返回到您的函数应用程序，并检查是否创建了名为 Function1 的 Azure 函数。如图 [15-28](#Fig28) 所示，您的函数现在包含一个名为 Function1 的函数。我们先获取这个函数的函数 URL，然后测试一下。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig28_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig28_HTML.jpg)

图 15-28

检查功能应用程序中的功能

打开 web 浏览器，粘贴函数 URL 和查询字符串`?name=ashirwad`来测试函数。如响应中所示，您的函数已成功部署到函数应用程序，并且正在按预期运行。参见图 [15-29](#Fig29) 。

![../images/510166_1_En_15_Chapter/510166_1_En_15_Fig29_HTML.jpg](../images/510166_1_En_15_Chapter/510166_1_En_15_Fig29_HTML.jpg)

图 15-29

函数返回的响应

## 摘要

在这一章中，你简要了解了 Azure DevOps 及其提供的服务套件。您探索了创建构建和发布管道的方法，包括在 GitHub 存储库中创建功能项目的构建包。您还了解了如何将其部署到现有的功能应用程序中。此外，我们讨论了通过持续集成和持续交付/部署来构建和发布管道的方法。本章的目的是探索使用 Azure DevOps 使用 CI/CD 管道部署功能的方法，但不要认为仅仅使用 Azure DevOps 就意味着你在遵循 DevOps。正如 Donovan Brown 所说，DevOps 是人员、流程和产品的结合，能够为您的最终用户持续交付价值。Azure DevOps 只是一个 DevOps 工具，在应用程序开发周期的不同阶段提供帮助，使用任何工具并不意味着你在练习 DevOps。

在下一章，你将探索在容器中部署和运行你的函数应用的方法。