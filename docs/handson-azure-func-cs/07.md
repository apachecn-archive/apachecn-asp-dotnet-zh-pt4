# 7.为 Azure 函数创建自定义绑定

绑定帮助 Azure Functions 服务轻松地与其他 Azure 服务和外部服务交换数据。您需要添加一个声明性配置来启用函数绑定。Azure 提供了大量现成的绑定。在大多数情况下，Azure 提供的绑定应该足以实现预期的应用程序功能，例如从 Blob 存储中读取数据，将一些数据放入队列存储中，从 RabbitMQ 触发绑定，等等。然而，在某些场景或用例中，Azure 提供的标准绑定可能不适合您的业务场景，或者您需要与 Azure Functions 没有现成绑定支持的新服务进行交互。对于这种情况，您可以根据需要构建自定义绑定。

在前一章中，您学习了如何使用 HTTP 触发器和表存储绑定来实现待办事项 API。在本章中，你将探索自定义绑定的概念，并学习如何为基于. NET Core 的 Azure 函数实现自定义绑定。

## 本章的结构

在本章中，你将探索 Azure 函数自定义绑定的以下方面:

*   自定义绑定简介

*   自定义绑定的用例

*   为 Azure 函数构建自定义绑定

## 目标

学习完本章后，您将能够做到以下几点:

*   了解 Azure 函数的自定义绑定

*   为 Azure 函数创建自定义绑定

## 自定义绑定简介

绑定要求您编写更少的代码，并简化您的代码。您需要在 Azure Functions 代码中添加声明性配置，以便与外部服务或 Azure 服务进行交互。Azure 提供了一系列现成的输入和输出绑定。但是，有些情况下，标准函数绑定可能无法满足您的业务需求。在这些情况下，您可以构建自定义输入或输出绑定来满足您的业务需求。创建自定义绑定是一项简单的一次性活动，绑定可以跨函数重用。

您可以使用。NET，只需遵循几个简单的步骤。您可以使用基于 WebJobs 扩展库的 Azure Functions SDK 创建自定义输入和输出绑定。您只需专注于为自定义绑定构建业务功能，大部分繁重的工作由底层完成。网络图书馆。一旦定制绑定准备好了，就可以像标准绑定一样在函数中使用它。

## 自定义绑定的用例

在创建自定义绑定之前，您应该首先确定现有绑定是否满足您的要求。Azure 提供了广泛的函数绑定，您应该能够使用这些绑定来管理大多数场景。对于下列情况，您可能需要构建自定义绑定:

*   现有的绑定不符合要求，您需要更多的功能来解决。例如，您需要更新 Azure 表存储中的一些实体。任何现有的 Azure 表存储绑定都不支持这种情况。

*   Azure Functions 没有针对 Azure 服务的绑定。例如，假设您需要为 Redis 与 Azure Cache 交互，并处理缓存数据。目前没有针对 Redis 的 Azure 缓存的绑定。

*   您需要连接外部非 Azure 服务或组件，并与之交换数据。例如，您需要从 Twitter 中提取一些数据。Azure 函数目前还没有与 Twitter 交互的绑定。

*   您需要用需要同时处理多个服务和组件的功能来实现特定的功能。例如，您可以构建一个绑定，从多个存储和数据源(如 Azure Cosmos DB、Azure SQL 或亚马逊 S3)获取数据，然后聚合数据。Azure 函数可以用这些数据构建一个自定义报告。

## 为 Azure 函数构建自定义绑定

让我们为 Azure 函数创建一个自定义绑定，帮助将数据从一种格式转换为另一种格式。第三方服务处理用户的数据，并将数据保存在第三方服务和 Azure 功能都可以访问的集中位置。第三方服务生成清单 [7-1](#PC1) 中列出的数据。

```cs
[name:Abhishek Mishra,Age:32,subject:maths]

Listing 7-1Data Format Generated by the Third-Party Service

```

Azure 函数需要进一步处理第三方服务生成的数据。然而，Azure 函数不理解当前生成的数据格式，只能处理清单 [7-2](#PC2) 中的格式。

```cs
{ "name":"Abhishek Mishra","Age":"32","subject":"maths" }

Listing 7-2Data Format That the Function Understands

```

在处理数据之前，您需要实现将格式化数据的代码，并且该代码将不可重用；它只对实现它的 Azure 函数有好处。为了处理这种情况，您可以创建一个自定义绑定，该绑定将从中央位置读取数据，进行必要的转换，然后将转换后的数据传递给 Azure 函数。您不必在函数级别实现代码，如果需要，可以在多个函数中使用绑定。见图 [7-1](#Fig1) 。

![../images/510166_1_En_7_Chapter/510166_1_En_7_Fig1_HTML.png](../images/510166_1_En_7_Chapter/510166_1_En_7_Fig1_HTML.png)

图 7-1

自定义绑定场景

您可以使用下列步骤创建自定义绑定。在本章中，您将使用 Visual Studio 2019 来构建自定义绑定。

1.  创建一个 Azure 函数。

2.  实现绑定属性类。

3.  实现绑定逻辑类。

4.  实现绑定扩展类。

5.  实现绑定启动类。

6.  在 Azure 函数中加入绑定。

现在让我们来实现这些步骤。

### 创建 Azure 函数

打开 Visual Studio 并单击“创建新项目”见图 [7-2](#Fig2) 。

![../images/510166_1_En_7_Chapter/510166_1_En_7_Fig2_HTML.jpg](../images/510166_1_En_7_Chapter/510166_1_En_7_Fig2_HTML.jpg)

图 7-2

创建一个功能项目

选择 Azure Functions 模板。单击下一步。见图 [7-3](#Fig3) 。

![../images/510166_1_En_7_Chapter/510166_1_En_7_Fig3_HTML.jpg](../images/510166_1_En_7_Chapter/510166_1_En_7_Fig3_HTML.jpg)

图 7-3

选择 Azure 函数模板

提供项目名称，然后单击创建。见图 [7-4](#Fig4) 。

![../images/510166_1_En_7_Chapter/510166_1_En_7_Fig4_HTML.jpg](../images/510166_1_En_7_Chapter/510166_1_En_7_Fig4_HTML.jpg)

图 7-4

提供功能项目详情

选择“Http 触发器”并单击创建。见图 [7-5](#Fig5) 。

![../images/510166_1_En_7_Chapter/510166_1_En_7_Fig5_HTML.jpg](../images/510166_1_En_7_Chapter/510166_1_En_7_Fig5_HTML.jpg)

图 7-5

选择“Http 触发器”

Azure 函数被创建。一旦定制绑定准备就绪，您将修改 Azure 函数代码。

### 实现绑定属性类

在本节中，您将添加一个类型的新项目。NET 标准类库添加到称为自定义绑定的解决方案中。若要向解决方案中添加新项目，请右击该解决方案，单击“添加”，然后单击“新建项目”。参见图 [7-6](#Fig6) 。

![../images/510166_1_En_7_Chapter/510166_1_En_7_Fig6_HTML.jpg](../images/510166_1_En_7_Chapter/510166_1_En_7_Fig6_HTML.jpg)

图 7-6

向解决方案中添加新项目

选择类库(。NET Standard)作为类类型，然后单击“下一步”。参见图 [7-7](#Fig7) 。

![../images/510166_1_En_7_Chapter/510166_1_En_7_Fig7_HTML.jpg](../images/510166_1_En_7_Chapter/510166_1_En_7_Fig7_HTML.jpg)

图 7-7

将项目类型设置为类库(。净标准)

提供项目名称作为 **CustomFormatBinding** 。

创建项目后，从 NuGet 添加以下包:

*   `Microsoft.NET.Sdk.Functions`

*   `Microsoft.Azure.WebJobs`

*   `Microsoft.Azure.Webjobs.Core`

现在让我们在 CustomFormatBinding 项目中添加一个名为`FormatterBindingAttribute.cs`的类。右击该项目，单击"添加"，然后单击"类"。见图 [7-8](#Fig8) 。

![../images/510166_1_En_7_Chapter/510166_1_En_7_Fig8_HTML.jpg](../images/510166_1_En_7_Chapter/510166_1_En_7_Fig8_HTML.jpg)

图 7-8

添加新类别

将清单 [7-3](#PC3) 中所示的代码放到`FormatterBindingAttribute.cs`类中。您需要创建一个自定义属性，您可以将其装饰为 Azure 函数的绑定。该属性有一个名为`DataFileLocation`的属性，它可以指向保存要格式化的文件的位置。您用`AutoResolve`属性修饰这个属性，以便它能够从`local.settings.json`文件中解析路径。

```cs
using Microsoft.Azure.WebJobs.Description;
using System;

namespace CustomFormatBinding
{
    [Binding]
    [AttributeUsage(AttributeTargets.Parameter | AttributeTargets.ReturnValue)]
    public class FormatterBindingAttribute:Attribute
    {
        [AutoResolve]
        public string DataFileLocation { get; set; }
    }
}

Listing 7-3FormatterBindingAttribute Class

```

### 实现绑定逻辑类

现在让我们实现绑定逻辑类。在这里，您将编写逻辑，将文件中的数据转换为函数处理数据所需的格式。在实现绑定逻辑类之前，让我们实现一个模型类，它将保存格式化的数据，并将作为函数的输入参数。在 CustomFormatBinding 项目中添加一个名为`FormatterModel.cs`的类，并用清单 [7-4](#PC4) 中所示的代码替换类代码。

```cs
using System;
using System.Collections.Generic;
using System.Text;

namespace CustomFormatBinding
{
    public class FormatterModel
    {
        public string DataFilePath { get; set; }
        public string Content { get; set; }
    }
}

Listing 7-4FormatterModel Class

```

现在让我们为 CustomFormatBinding 项目中的绑定逻辑添加一个类。你将把这个类命名为`FormatterBinding.cs`。这个类中有一个`Initialize`方法，它添加了一个指定转换操作逻辑的绑定规则。`Convert`执行数据格式化活动，必须作为参数传递给`BindToInput`方法。用创建类时生成的代码替换清单 [7-5](#PC5) 中的代码。

```cs
using System.IO;
using Microsoft.Azure.WebJobs.Description;
using Microsoft.Azure.WebJobs.Host.Config;

namespace CustomFormatBinding
{
    [Extension("MyFileReaderBinding")]
    public class FormatterBinding : IExtensionConfigProvider
    {
        public void Initialize(ExtensionConfigContext context)
        {
            var rule = context.AddBindingRule<FormatterBindingAttribute>();
            rule.BindToInput<FormatterModel>(BuildItemFromAttribute);
        }

        private FormatterModel BuildItemFromAttribute(FormatterBindingAttribute
        arg)
        {
            string formattedData = string.Empty;
            if (File.Exists(arg.DataFileLocation))
            {
                formattedData = "{";
                string formattedDataAsIs =
                File.ReadAllText(arg.DataFileLocation);
                // Replace the start [ and end ]
                formattedDataAsIs= formattedDataAsIs.TrimStart(new char[] { '['
                }).TrimEnd(new char[] { ']' });
                // Data formatting activity/logic
                string[] tokens = formattedDataAsIs.Split(new char[] { ',' });
                foreach (var token in tokens)
                {
                    string[] subToken = token.Split(new char[] { ':' });
                    formattedData = formattedData + "\"" + subToken[0] + "\" :
                    " + "\"" + subToken[1] + "\" , ";
                }
                formattedData = formattedData.Trim().TrimEnd(new char[] { ','
                });
                formattedData = formattedData + "}";
            }

            return new FormatterModel
            {
                DataFilePath = arg.DataFileLocation,
                FormattedData = formattedData
            };
        }
    }
}

Listing 7-5FormatterBinding Class

```

### 实现绑定扩展类

现在让我们实现绑定扩展类。在 CustomFormatBinding 项目中创建一个名为`BindingExtension.cs`的新类。将清单 [7-6](#PC6) 中的代码放到类中。您将调用`Startup`类中的方法`AddCustomBinding`。当该方法被调用时，它将调用绑定格式化程序类进行必要的转换并返回转换后的数据。

```cs
using Microsoft.Azure.WebJobs;
using System;

namespace CustomFormatBinding
{
    public static class BindingExtension
    {
        public static IWebJobsBuilder AddCustomBinding(this IWebJobsBuilder
        builder)
        {
            if (builder == null)
            {
                throw new ArgumentNullException(nameof(builder));
            }

            builder.AddExtension<FormatterBinding>();
            return builder;
        }
    }
}

Listing 7-6BindingExtension Class

```

### 实现绑定启动类

现在让我们创建启动类，它将把绑定注入到运行时执行上下文中。在 CustomFormatBinding 项目中添加一个名为`BindingStartup.cs`的类。在类中使用清单 [7-7](#PC7) 中的代码。

```cs
using CustomFormatBinding;
using Microsoft.Azure.WebJobs;
using Microsoft.Azure.WebJobs.Hosting;

[assembly: WebJobsStartup(typeof(BindingStartup))]
namespace CustomFormatBinding
{
    public class BindingStartup : IWebJobsStartup
    {
        public void Configure(IWebJobsBuilder builder)
        {
            builder.AddCustomBinding();
        }
    }
}

Listing 7-7BindingStartup Class

```

### 在 Azure 函数中加入绑定

现在让我们添加您在 Azure 函数中创建的自定义绑定。确保在函数项目中添加了对 CustomFormatBinding 项目的`using`引用。您传递一个类型为`FormatterModel`的名为`formatterModel`的参数，并用属性`FormatterBinding`来修饰它。`formatterBinding`参数将有格式化的数据。我们之前在 CustomFormatBinding 项目中创建了`FormatterBinding`属性和`FormatterModel`。清单 [7-8](#PC8) 展示了 Azure 函数的代码。

```cs
using System.IO;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Azure.WebJobs;
using Microsoft.Azure.WebJobs.Extensions.Http;
using Microsoft.Extensions.Logging;
using Newtonsoft.Json;
using CustomFormatBinding;

namespace FuncBindingDemo
{
    public static class Function1
    {
        [FunctionName("Function1")]
        public static IActionResult Run(
             [HttpTrigger(AuthorizationLevel.Anonymous, "get", "post", Route =
             "custombinding/{name}")]
             HttpRequest req,
             ILogger log,
             string name,
             [FormatterBinding(DataFileLocation = "%filepath%\\{name}")]
            FormatterModel formatterModel)
        {
            return (ActionResult)new
            OkObjectResult(formatterModel.FormattedData);
        }
    }
}

Listing 7-8Function Class

```

添加`filepath`参数，并在`local.settings.json`文件中指定文件的集中位置。参见清单 [7-9](#PC9) 。

```cs
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "UseDevelopmentStorage=true",
    "FUNCTIONS_WORKER_RUNTIME": "dotnet",
    "filepath": "C:\\Abhishek\\Test\\"
  }
}

Listing 7-9Local.settings.json File

```

将清单 [7-10](#PC10) 中内容的文件放在`local.settings.json`文件中`filepath`中您提供的位置。

```cs
[name:Abhishek Mishra,Age:38,subject:maths]

Listing 7-10Content of File to Be Converted by the Binding

```

执行该功能。参见图 [7-9](#Fig9) 。

![../images/510166_1_En_7_Chapter/510166_1_En_7_Fig9_HTML.jpg](../images/510166_1_En_7_Chapter/510166_1_En_7_Fig9_HTML.jpg)

图 7-9

功能执行输出

在函数 URL route 中传递文件名。绑定将转换数据，函数在浏览器中返回转换后的数据。参见图 [7-10](#Fig10) 。

![../images/510166_1_En_7_Chapter/510166_1_En_7_Fig10_HTML.jpg](../images/510166_1_En_7_Chapter/510166_1_En_7_Fig10_HTML.jpg)

图 7-10

浏览到该函数

## 摘要

在本章中，您学习了什么是自定义绑定，以及需要使用自定义绑定的场景。您探索了创建自定义绑定所需的不同步骤，然后使用 Visual Studio 实现了自定义绑定。您创建了一个自定义绑定，它将现有数据的数据格式转换为函数进一步处理数据所需的格式。您将数据转换的逻辑合并到绑定中，然后在函数中应用绑定，无需编写太多代码就可以获得格式化的数据。

以下是本章的要点:

*   只要标准函数绑定不符合您的情况，您就可以创建自定义绑定。

*   您需要使用. NET 构建自定义绑定。

*   您可以跨函数重用自定义绑定。

*   以下是创建自定义绑定并在 Azure 函数中使用它的步骤:
    1.  创建一个 Azure 函数。

    2.  实现绑定属性类。

    3.  实现绑定逻辑类。

    4.  实现绑定扩展类。

    5.  实现绑定启动类。

    6.  在 Azure 函数中加入绑定。

在下一章，你将探索如何使用 Azure 函数创建无服务器 API。