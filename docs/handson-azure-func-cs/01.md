# 一、Azure 函数简介

功能即服务(FaaS)在所有主要的云平台上越来越受欢迎。有了 FaaS，你可以构建短时间运行的小块代码，并将它们托管在 FaaS 云产品上。您可以按函数运行的时间付费，并且您不需要担心托管基础设施和伸缩方面的问题。

微软 Azure 以 FaaS 的形式提供 Azure 函数。你构建你的功能代码，并将其托管在 Azure Functions 上，Azure Functions 是 Azure App Service 的一部分。底层平台负责所有的托管和扩展需求。与云中其他可用的托管服务相比，在 Azure 函数上执行代码在大多数情况下都是划算的。

在这一章中，你将对 Azure 函数有一个基本的了解，这将帮助你轻松掌握接下来的章节。

## 本章的结构

在这一章中，我们将探索 Azure 函数的以下方面:

*   Azure 函数简介

*   无服务器简介

*   Azure WebJobs 与 Azure Functions

*   Azure 函数的优点和缺点

*   Azure 函数的托管计划

*   Azure 函数的用例

## 目标

学习完本章后，您将能够做到以下几点:

*   了解无服务器计算和 Azure 函数的基础知识

*   确定可以使用 Azure 函数的场景

## Azure 函数简介

Azure Functions 是微软 Azure 平台上的无服务器计算服务，基于 FaaS 计算模型。你需要构建你的代码，运行一个函数，并在 Azure 函数上托管你的代码。底层云平台管理托管基础设施和托管软件。您不需要担心托管代码的伸缩性。底层的 Azure 平台为运行在 Azure 函数上的代码管理所有的扩展方面。当该功能处于活动状态并开始工作时，您会收到账单。每当 Azure Functions 空闲时，您都不会收到账单。

Azure Functions 托管短时间间隔运行的代码。但是，您可以通过为该函数选择合适的宿主计划来增加执行时间。使用触发器调用函数并开始运行。Azure Functions 支持广泛的触发器。例如，计时器可以在预定义的时间间隔触发一个函数，队列存储中的新消息可以触发它，或者一个简单的 HTTP 调用可以触发一个函数。Azure Functions 使用绑定与各种服务进行交互，比如 Blob 存储、表存储、队列存储、事件网格、Cosmos DB、服务总线队列等等。您可以以声明方式声明触发器和绑定，而无需编写任何代码。

Azure Functions 支持三个运行时版本和一系列基于您选择的运行时的编程语言。3. *x* 是最新的运行时，1。 *x* 是可用的最老的运行时。你可以使用表 [1-1](#Tab1) 中的任何编程语言来构建你的代码。

表 1-1

Azure 函数运行时和支持的编程语言

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"> <col class="tcol3 align-left"> <col class="tcol4 align-left"></colgroup> 
| 

语言

 | 

运行时 1。 ***x***

 | 

运行时 2。 ***x***

 | 

运行时 3。 ***x***

 |
| --- | --- | --- | --- |
| C# | 。NET 4.7 | 。网络核心 2.2 | 。网络核心 3.1 |
| Java Script 语言 | 节点 6 | 节点 10 和 8 | 节点 12 和 10 |
| F# | 。NET 4.7 | 。网络核心 2.2 | 。网络核心 3.1 |
| 爪哇 | 不支持 | Java 8 | Java 11 和 8 |
| 管理员 | 不支持 | PowerShell Core 6 | PowerShell 7 和 Core 6 |
| 计算机编程语言 | 不支持 | Python 3.7 和 3.6 | Python 3.8、3.7 和 3.6 |
| 以打字打的文件 | 不支持 | 支持 | 支持 |

每当被触发器调用时，函数就会执行。该函数运行特定的时间间隔，并进入空闲状态。每当它被触发器再次调用时就会被唤醒。该函数需要一些时间来预热，并在被触发时开始执行。

## 无服务器简介

一旦你启动云服务，你就开始为其付费。即使您不使用这些服务，也会收到账单。此外，您需要为这些服务规划和配置扩展策略。有些服务为您提供了设置自动缩放的灵活性，而对于其他服务，您需要手动设置缩放配置。无论哪种情况，您最终都要提供必要的设置，以便服务可以伸缩。

在无服务器云服务的情况下，当服务运行并执行您的托管代码时，您会收到账单，而当服务空闲且不执行任何事情时，您不会收到账单。您可以根据实际消费情况向云供应商付费，这样可以节省您的资金。底层平台管理在无服务器服务中运行的应用的所有扩展方面。您不需要为无服务器服务配置任何缩放设置。无服务器服务足够智能，可以添加新的实例来处理传入流量，并在传入流量减少时删除额外的实例。

无服务器并不意味着云服务不托管在任何服务器上。没有服务器就不能运行任何代码。对于无服务器服务，您无法控制承载代码的服务器。你需要把你的代码放在无服务器的服务上，而不用担心底层的基础设施。云供应商管理底层基础设施。

以下是微软 Azure 提供的一些流行的无服务器产品:

*   天青函数

*   Azure 逻辑应用

*   Azure 事件网格

*   无服务器蓝色库服务

*   无服务器 SQL 数据库

Note

在无服务器服务和平台即服务(PaaS)的情况下，您可以获得代码并将其托管在服务上，而无需管理底层基础架构。云供应商管理基础设施。然而，在 PaaS 的情况下，您需要管理扩展方面。云供应商管理无服务器服务的扩展。就 PaaS 而言，一旦你启动了服务，你就会收到账单。然而，在无服务器服务中，当服务处于活动状态并执行您的代码时，您会收到账单。

## Azure WebJobs 与 Azure Functions

您可以在应用服务计划中创建一个 WebJobs 作业。web job 作为后台工作人员为 Azure App Service 上托管的应用工作。例如，您可以托管一个便于用户在 Azure Blob 存储中上传文件的应用。通常，这些文件是用户特定的格式。在应用处理文件之前，应该将文件转换成应用可以理解的标准格式。在这种情况下，您可以在同一个应用服务计划中创建 web 作业。这个 web 作业将作为后台工作人员运行，获取用户上传的文件，并将其转换为应用可以理解的格式。Web 作业可以使用各种各样的触发器来触发，如 Azure 队列存储、Cosmos DB、Azure Blob 存储、Azure 服务总线、Azure 事件中心等等。Azure WebJobs 满足了开发者后台处理的所有必要需求。但是，它与 Azure App Service 共享相同的应用服务计划。共享相同的应用服务计划意味着共享相同的底层计算基础设施。底层基础设施的这种共享有时会导致性能瓶颈。

函数不仅仅意味着处理后台任务。它们也可以承载应用的业务逻辑。但是，它们非常适合于运行时间间隔很短的宿主代码。这些功能是无服务器产品，可以独立扩展。底层基础设施管理该功能的所有扩展方面。Web 作业与 Azure 应用服务实例相关联，并且随着 Azure 应用服务实例的扩展而扩展。您需要为每个 web 作业明确设置缩放配置。函数可以在使用基于消耗的计划触发时运行，也可以使用专用计划连续运行。Web 作业总是绑定到应用服务计划，这是一个专用的托管计划。但是，您不会因 web 作业而单独付费。它们附带了应用服务计划。Azure 门户提供了一个基于浏览器的编辑器，您可以使用它在 Azure 门户内部构建、测试和部署功能。这个特性提高了开发人员的工作效率。您可以轻松地将 Azure 函数与 Azure Logic 应用集成，并在 Azure 上构建企业级解决方案。Azure Functions 支持各种触发器，如 HTTP WebHooks (GitHub/Slack)和 Azure Event Grid，Azure WebJobs 不支持这些触发器。

## Azure 函数的优点和缺点

你构建你的代码并在 Azure 函数上托管它，而不用担心底层的托管基础设施。云供应商负责所有的托管方面，如托管服务器和托管软件。作为一名开发人员，您可以有更多的时间专注于构建应用代码和开发其功能。底层基础设施可以扩展您的应用，而无需您配置扩展设置。此外，当一个函数被触发并且代码被执行时，你会收到账单。这个功能可以为您省钱。你可以将 Azure 函数与逻辑应用一起使用，构建真正的企业级应用。事实上，您可以轻松地将 Azure 函数与各种 Azure 服务集成在一起。Azure Functions 非常适合执行短时间间隔运行的代码。你可以把你的应用功能分解成更小的块，并把它放在 Azure 函数上。这将帮助您在更细粒度的级别引入单一责任模式。单一责任模式声明软件程序的模块或组件应该执行程序的单一功能。例如，在计算器应用中，应该有一个执行加法运算的组件或模块，一个执行减法运算的不同组件，等等。应用的组件应该被设计成执行单一的功能，而不是为应用做所有的事情。

然而，函数在被触发时执行，当它们不做任何工作时进入空闲状态。每当一个函数空闲时，它需要一段时间才能在被触发时生效。这是因为底层基础设施预热并开始执行代码需要一些时间。这种现象被称为*冷启动*问题，你在设计 Azure 函数的解决方案时必须考虑这个问题。有时，与在 Azure Web App 上托管您的代码相比，Azure 函数的成本会更高。每当负载增加时，底层平台就会为 Azure 函数增加新的实例，而您对伸缩方面没有任何控制。旋转更多实例将增加您的解决方案的成本。您应该预测应用的用户并发性，并对解决方案进行正确的成本估算。此外，您应该设计一个适当的策略，使用队列或其他一些技术来控制或管理用户并发性，并在您的解决方案中控制 Azure 函数的可伸缩性程度。

## Azure 函数的托管计划

托管计划可帮助您选择该功能的底层基础设施规范，定义该功能应如何扩展，并设置该功能将需要的任何其他高级功能，如虚拟网络支持。根据你为 Azure 函数选择的托管方案，你会收到账单。以下是 Azure 函数支持的托管计划:

*   消费计划

*   保费计划

*   专用计划

## 消费计划

在消费计划的情况下，您无法控制功能如何扩展。底层的 Azure 平台基于函数接收的输入流量动态地添加或删除实例。您对底层托管基础设施没有任何控制权。该功能运行时，您会收到账单。这个托管计划是一个理想的无服务器计划，但你可能会遇到冷启动现象。Azure Functions 实例需要一段时间来预热，并在被触发时投入运行。当函数被触发时，您的代码不会立即运行，因为需要一段时间才能从空闲状态中醒来。这种现象被称为冷启动现象。在消费计划的情况下，该函数最多可以执行十分钟，默认值为五分钟。默认值五分钟指的是函数在没有明确设置函数超时值的情况下超时之前将执行的时间。

## 保费计划

在 Premium Plan 的情况下，您可以拥有预先准备好的 Azure Functions 实例，这些实例可以在函数被触发时立即行动并执行代码。预热实例帮助您克服冷启动现象。就像消费计划一样，你无法控制 Azure 函数如何扩展，也无法控制高级计划中的底层托管基础设施。但是，您可以选择 SKU (EP1、EP2 或 EP3)来满足您的应用的内存和 CPU 需求。底层的 Azure 平台管理所有的扩展方面。你得到了虚拟网络的支持。在高级计划的情况下，您可以将功能配置为运行更长时间而不会超时。默认情况下，函数执行将在 30 分钟后超时。您的功能可以连续运行或几乎连续运行。

## 专用计划

Azure Functions 中的专用计划与 Azure WebApp 中的 App 服务计划相同。与高级计划相比，您可以从大量 SKU 和尺寸中进行选择，以满足应用的内存和 CPU 要求。您可以为您的功能配置手动缩放或自动缩放。您还可以获得虚拟网络支持。这个托管计划最适合长时间运行的应用。

## Azure 函数的用例

Azure Functions 服务可以适应任何现代应用模式和用例。以下是一些最适合使用 Azure 函数的场景:

*   您可以使用 Azure 函数构建一个 *n* 层应用。您可以将业务和数据访问逻辑分成更小的块，并在一个函数中托管这些块。

*   你可以在 Azure 函数中运行后台处理作业。

*   您可以使用 Azure 函数和持久函数来构建基于工作流的应用，其中您可以使用 Azure 持久函数和 Azure 函数来编排每个工作流步骤。

*   你可以使用 Azure 函数来构建基于微服务的应用。每个功能可以托管一个业务服务。

*   您可以使用 Azure 函数来构建基于时间表的应用，这些应用在特定的时间间隔或一天、一月或一年的特定时间运行。

*   您可以构建通知系统，根据条件和事件触发通知最终用户或系统的功能。

*   您可以在物联网(IoT)场景中使用 Azure 函数来实现执行业务活动或处理摄取的数据并将其放入存储或发送到下一组处理的功能。

*   您可以在事件驱动的场景中使用 Azure 函数和 Azure Event Grid，这些函数可以被触发并执行任务。

## 摘要

在这一章中，你学习了 Azure 函数的基础。您探索了什么是 Azure Functions，并讨论了无服务器计算的概念。然后，您了解了 Azure WebJobs 与 Azure Functions 的不同之处，并探索了使用 Azure Functions 的优缺点以及使用该服务的场景。您还了解了 Azure 函数可用的不同托管计划。

以下是本章的要点:

*   Azure Functions 是微软 Azure 平台上的无服务器计算服务，基于 FaaS 计算模型。

*   你需要构建你的代码，运行一个函数，并在 Azure 函数上托管你的代码。底层云平台管理托管基础设施和托管软件。

*   底层平台管理 Azure 函数的扩展方面，你不需要做任何扩展配置。

*   当一个函数执行时，您会收到账单，而当一个函数空闲时，您不会产生任何成本。

*   Azure Functions 支持消费、高级和专用计划。

*   你可以在当前的场景中使用 Azure 函数，比如物联网、微服务、事件驱动的应用等等。